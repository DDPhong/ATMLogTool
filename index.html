<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATMLogTool - Tr√¨nh ƒë·ªçc Log B·∫£o m·∫≠t</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 500px; text-align: center; }
        .app-container { max-width: 1000px; width: 95%; align-self: flex-start; margin-top: 20px; text-align: left; }
        h2 { color: #1c1e21; margin-bottom: 20px; }
        input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        .logout-btn { background-color: #dc3545; width: auto; padding: 8px 15px; float: right; }
        
        /* Giao di·ªán ƒë·ªçc Log */
        #log-viewer { width: 100%; height: 400px; margin-top: 20px; font-family: 'Consolas', monospace; background: #282a36; color: #f8f8f2; padding: 15px; border-radius: 8px; border: none; overflow: auto; white-space: pre; }
        #app-ui { display: none; }
        .file-input-group { background: #fff; padding: 20px; border-radius: 8px; border: 2px dashed #007bff; margin: 20px 0; text-align: center; }
    </style>
</head>
<body>

    <div id="login-ui" class="box">
        <h2>ATMLogTool Login</h2>
        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng c√¥ng c·ª•</p>
        <input type="email" id="email" placeholder="Email (v√≠ d·ª•: admin@atmlog.com)">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>
        <p id="error-msg" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="app-ui" class="box app-container">
        <button class="logout-btn" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
        <h2>Tr√¨nh ƒë·ªçc Log ATM</h2>
        <p>Tr·∫°ng th√°i: <span style="color: green; font-weight: bold;">ƒê√£ k·∫øt n·ªëi</span></p>
        
        <div class="file-input-group">
                    <label for="filePicker" style="cursor: pointer; color: #007bff; font-weight: bold;">
            M·ªùi ch·ªçn file Log (.log, .txt, .jrn) t·ª´ m√°y t√≠nh
        </label>
            <input type="file" id="filePicker" accept=".log,.txt,.jrn" style="display: block; margin: 10px auto;">
        </div>

        <div id="file-details" style="font-size: 14px; color: #666;"></div>
        <div class="main-content" style="margin-top: 20px;">
    
    <div style="margin-bottom: 15px;">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç G√µ s·ªë th·∫ª, t√™n kh√°ch h√†ng ho·∫∑c m√£ Trace ƒë·ªÉ t√¨m..." 
               style="width: 100%; padding: 12px; border: 2px solid #007bff; border-radius: 5px; font-size: 16px;">
    </div>

    <div style="overflow-x: auto; max-height: 600px; border: 1px solid #ddd;">
        <table id="logTable" style="width: 100%; border-collapse: collapse; font-family: sans-serif; font-size: 14px;">
            <thead>
                <tr style="background: #007bff; color: white; position: sticky; top: 0;">
                    <th style="padding: 12px; text-align: left;">Th·ªùi gian</th>
                    <th style="padding: 12px; text-align: left;">Trace</th>
                    <th style="padding: 12px; text-align: left;">S·ªë th·∫ª</th>
                    <th style="padding: 12px; text-align: left;">Kh√°ch h√†ng</th>
                    <th style="padding: 12px; text-align: left;">S·ªë ti·ªÅn</th>
                    <th style="padding: 12px; text-align: left;">Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                        Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªçn file Log ph√≠a tr√™n.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
    </div>

    <script>
        // ==========================================
        // B∆Ø·ªöC QUAN TR·ªåNG: D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // ==========================================
       // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAI9JLeO3Wd4i-AOUGHRFVlNI4ZnVRv6I4",
          authDomain: "atmlogtoolauth.firebaseapp.com",
          projectId: "atmlogtoolauth",
          storageBucket: "atmlogtoolauth.firebasestorage.app",
          messagingSenderId: "813329348858",
          appId: "1:813329348858:web:afa726940ad9b8c37cb143",
          measurementId: "G-1TF3R94EW9"
        };
        // ==========================================

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª± ƒë·ªông
        auth.onAuthStateChanged((user) => {
            const loginUI = document.getElementById('login-ui');
            const appUI = document.getElementById('app-ui');
            
            if (user) {
                loginUI.style.display = 'none';
                appUI.style.display = 'block';
            } else {
                loginUI.style.display = 'block';
                appUI.style.display = 'none';
            }
        });

        // H√†m x·ª≠ l√Ω ƒêƒÉng nh·∫≠p
        function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { errorMsg.innerText = ""; })
                .catch((error) => { errorMsg.innerText = "L·ªói: " + error.message; });
        }

        // H√†m x·ª≠ l√Ω ƒêƒÉng xu·∫•t
        function handleLogout() {
            auth.signOut();
        }

        // X·ª≠ l√Ω ƒë·ªçc File sau khi ng∆∞·ªùi d√πng ch·ªçn file
        document.getElementById('filePicker').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Hi·ªÉn th·ªã t√™n file ngay l·∫≠p t·ª©c ƒë·ªÉ bi·∫øt web ƒë√£ nh·∫≠n file
    document.getElementById('file-details').innerText = `ƒêang ƒë·ªçc: ${file.name}...`;

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        // ƒê·ªï d·ªØ li·ªáu v√†o √¥ xem Log
        document.getElementById('log-viewer').value = content;
        document.getElementById('file-details').innerText = `File: ${file.name} | Dung l∆∞·ª£ng: ${(file.size/1024).toFixed(2)} KB`;
    };
    
    // ƒê·∫£m b·∫£o d√πng b·∫£ng m√£ UTF-8 ƒë·ªÉ kh√¥ng b·ªã l·ªói font ti·∫øng Vi·ªát ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát trong Log
    reader.readAsText(file, "UTF-8"); 
});        
    </script>

    <script>
    // 1. C√°c c·∫•u h√¨nh Firebase c·ªßa b·∫°n d√°n ·ªü ƒë√¢y...

    // 2. H√†m Parser (B·ªô n√£o l·ªçc d·ªØ li·ªáu) - D√°n ƒëo·∫°n n√†y v√†o
    function parseATMLog(rawText) {
        const lines = rawText.split('\n');
        const transactions = [];
        let currentTrans = null;

        lines.forEach(line => {
            if (line.includes("TRANSACTION START")) {
                currentTrans = {
                    time: line.substring(0, 19),
                    type: line.includes("CARDLESS") ? "Kh√¥ng th·∫ª" : "Giao d·ªãch th·∫ª",
                    trace: "", card: "", name: "", amount: "0", status: "Ch·ªù..."
                };
            } 
            if (currentTrans) {
                if (line.includes("TRACE :")) currentTrans.trace = line.split(":")[1].trim();
                if (line.includes("CARD NUMBER")) currentTrans.card = line.split("NUMBER")[1].trim();
                if (line.includes("CUSTOMER NAME :")) currentTrans.name = line.split(":")[1].trim();
                if (line.includes("AMOUNT:")) currentTrans.amount = line.split(":")[1].trim();
                
                // Nh·∫≠n di·ªán k·∫øt qu·∫£
                if (line.includes("Success")) currentTrans.status = "Th√†nh c√¥ng";
                if (line.includes("ERROR") || line.includes("TIMEOUT")) currentTrans.status = "L·ªói/Timeout";
                if (line.includes("Money Taken")) currentTrans.status = "Th√†nh c√¥ng (ƒê√£ l·∫•y ti·ªÅn)";

                if (line.includes("TRANSACTION END")) {
                    transactions.push(currentTrans);
                    currentTrans = null;
                }
            }
        });
        return transactions;
    }

    // 3. H√†m hi·ªÉn th·ªã d·ªØ li·ªáu l√™n b·∫£ng
    function displayTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©
        data.forEach(item => {
            const row = `<tr>
                <td>${item.time}</td>
                <td>${item.trace}</td>
                <td>${item.card}</td>
                <td>${item.name}</td>
                <td>${item.amount}</td>
                <td style="color: ${item.status.includes('L·ªói') ? 'red' : 'green'}">${item.status}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // 4. S·ª± ki·ªán khi ch·ªçn file (K·∫øt n·ªëi b·ªô ƒë·ªçc v·ªõi b·∫£ng)
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const parsedData = parseATMLog(content); // Chuy·ªÉn vƒÉn b·∫£n th√†nh danh s√°ch
            displayTable(parsedData); // ƒê·ªï danh s√°ch v√†o b·∫£ng
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>
