<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATMLogTool Professional</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .app-container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .logout-btn { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* Khu v·ª±c ch·ªçn file gi·ªëng ·∫£nh image_a14788.png */
        .file-input-group { 
            border: 2px dashed #007bff; padding: 30px; text-align: center; 
            border-radius: 8px; background: #f8fbff; margin: 20px 0; 
        }
        
        #searchInput { 
            width: 100%; padding: 12px; border: 1px solid #007bff; 
            border-radius: 4px; font-size: 15px; margin-bottom: 15px; box-sizing: border-box;
        }

        /* B·∫£ng hi·ªÉn th·ªã chuy√™n nghi·ªáp */
        .table-wrapper { overflow-x: auto; max-height: 600px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead th { background: #007bff; color: white; position: sticky; top: 0; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        tr:hover { background-color: #f1f7ff; }
        
        .status-ok { color: #28a745; font-weight: bold; }
        .status-fail { color: #d63301; font-weight: bold; }
        #loading-text { color: #666; font-size: 13px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app-ui" class="app-container">
    <div class="header-flex">
        <h2>Tr√¨nh ƒë·ªçc Log ATM</h2>
        <button class="logout-btn" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
    </div>
    
    <p>Tr·∫°ng th√°i: <span style="color: green; font-weight: bold;">ƒê√£ k·∫øt n·ªëi</span></p>

    <div class="file-input-group">
        <label for="filePicker" style="cursor: pointer; color: #007bff; font-weight: bold;">
            M·ªùi ch·ªçn file Log (.log, .txt, .jrn) t·ª´ m√°y t√≠nh
        </label>
        <input type="file" id="filePicker" accept=".log,.txt,.jrn" style="display: block; margin: 15px auto;">
    </div>

    <div id="loading-text">Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn.</div>

    <div class="main-content">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç G√µ s·ªë th·∫ª, t√™n kh√°ch h√†ng ho·∫∑c m√£ Trace ƒë·ªÉ t√¨m...">
        
        <div class="table-wrapper">
            <table id="logTable">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>Trace</th>
                        <th>S·ªë th·∫ª</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>S·ªë ti·ªÅn (VND)</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªçn file Log ph√≠a tr√™n.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. C·∫§U H√åNH FIREBASE (D√ÅN M√É C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
  // Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAI9JLeO3Wd4i-AOUGHRFVlNI4ZnVRv6I4",
  authDomain: "atmlogtoolauth.firebaseapp.com",
  projectId: "atmlogtoolauth",
  storageBucket: "atmlogtoolauth.firebasestorage.app",
  messagingSenderId: "813329348858",
  appId: "1:813329348858:web:afa726940ad9b8c37cb143",
  measurementId: "G-1TF3R94EW9"
};
    firebase.initializeApp(firebaseConfig);

    // --- 2. X·ª¨ L√ù ƒê·ªåC FILE ---
    document.getElementById('filePicker').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('loading-text').innerText = `ƒêang ƒë·ªçc: ${file.name}...`;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const transactions = parseATMLog(content);
            renderTable(transactions);
            document.getElementById('loading-text').innerText = `ƒê√£ ƒë·ªçc xong: ${file.name}`;
        };
        reader.readAsText(file);
    });

    // --- 3. B·ªò L·ªåC D·ªÆ LI·ªÜU LOG (D·ª±a tr√™n m·∫´u ·∫£nh image_a0d744) ---
    function parseATMLog(text) {
        const lines = text.split('\n');
        const results = [];
        let current = null;

        lines.forEach(line => {
            // Nh·∫≠n di·ªán b·∫Øt ƒë·∫ßu giao d·ªãch
            if (line.includes("TRANSACTION START")) {
                current = { 
                    time: line.substring(0, 19).trim(), 
                    trace: "", card: "", name: "", amount: "0", status: "Ch∆∞a r√µ" 
                };
            }

            if (current) {
                // Tr√≠ch xu·∫•t th√¥ng tin theo t·ª´ kh√≥a trong ·∫£nh c·ªßa b·∫°n
                if (line.includes("TRACE :")) current.trace = line.split(":")[1].trim();
                if (line.includes("CARD NUMBER")) current.card = line.split("NUMBER")[1].trim();
                if (line.includes("CUSTOMER NAME :")) current.name = line.split(":")[1].trim();
                if (line.includes("CUSTOMER SELECTED AMOUNT :")) current.amount = line.split(":")[1].trim();
                
                // X√°c ƒë·ªãnh tr·∫°ng th√°i th√†nh c√¥ng
                if (line.includes("Money Taken") || line.includes("Success")) {
                    current.status = "Th√†nh c√¥ng";
                }
                if (line.includes("ERROR") || line.includes("TIMEOUT")) {
                    current.status = "L·ªói/H·ªßy";
                }

                // K·∫øt th√∫c giao d·ªãch
                if (line.includes("TRANSACTION END")) {
                    results.push(current);
                    current = null;
                }
            }
        });
        return results;
    }

    // --- 4. HI·ªÇN TH·ªä L√äN B·∫¢NG ---
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => `
            <tr>
                <td>${item.time}</td>
                <td><b>${item.trace}</b></td>
                <td>${item.card}</td>
                <td>${item.name}</td>
                <td>${Number(item.amount).toLocaleString()}</td>
                <td class="${item.status === 'Th√†nh c√¥ng' ? 'status-ok' : 'status-fail'}">${item.status}</td>
            </tr>
        `).join('');
    }

    // --- 5. T√åM KI·∫æM NHANH ---
    function filterTable() {
        const filter = document.getElementById("searchInput").value.toUpperCase();
        const rows = document.getElementById("tableBody").getElementsByTagName("tr");

        for (let row of rows) {
            const text = row.textContent || row.innerText;
            row.style.display = text.toUpperCase().includes(filter) ? "" : "none";
        }
    }

    // --- 6. ƒêƒÇNG XU·∫§T ---
    function handleLogout() {
        firebase.auth().signOut().then(() => {
            location.reload();
        });
    }
</script>

</body>
</html>
