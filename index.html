<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATMLogTool - Trình đọc Log Bảo mật</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 500px; text-align: center; }
        .app-container { max-width: 1000px; width: 95%; align-self: flex-start; margin-top: 20px; text-align: left; }
        h2 { color: #1c1e21; margin-bottom: 20px; }
        input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        .logout-btn { background-color: #dc3545; width: auto; padding: 8px 15px; float: right; }
        
        /* Giao diện đọc Log */
        #log-viewer { width: 100%; height: 400px; margin-top: 20px; font-family: 'Consolas', monospace; background: #282a36; color: #f8f8f2; padding: 15px; border-radius: 8px; border: none; overflow: auto; white-space: pre; }
        #app-ui { display: none; }
        .file-input-group { background: #fff; padding: 20px; border-radius: 8px; border: 2px dashed #007bff; margin: 20px 0; text-align: center; }
    </style>
</head>
<body>

    <div id="login-ui" class="box">
        <h2>ATMLogTool Login</h2>
        <p>Vui lòng đăng nhập để sử dụng công cụ</p>
        <input type="email" id="email" placeholder="Email (ví dụ: admin@atmlog.com)">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="handleLogin()">Đăng nhập</button>
        <p id="error-msg" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="app-ui" class="box app-container">
        <button class="logout-btn" onclick="handleLogout()">Đăng xuất</button>
        <h2>Trình đọc Log ATM</h2>
        <p>Trạng thái: <span style="color: green; font-weight: bold;">Đã kết nối</span></p>
        
        <div class="file-input-group">
                    <label for="filePicker" style="cursor: pointer; color: #007bff; font-weight: bold;">
            Mời chọn file Log (.log, .txt, .jrn) từ máy tính
        </label>
            <input type="file" id="filePicker" accept=".log,.txt,.jrn" style="display: block; margin: 10px auto;">
        </div>

        <div id="file-details" style="font-size: 14px; color: #666;"></div>
        <textarea id="log-viewer" readonly placeholder="Nội dung log sẽ hiển thị tại đây..."></textarea>
    </div>

    <script>
        // ==========================================
        // BƯỚC QUAN TRỌNG: DÁN CONFIG CỦA BẠN VÀO ĐÂY
        // ==========================================
       // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAI9JLeO3Wd4i-AOUGHRFVlNI4ZnVRv6I4",
          authDomain: "atmlogtoolauth.firebaseapp.com",
          projectId: "atmlogtoolauth",
          storageBucket: "atmlogtoolauth.firebasestorage.app",
          messagingSenderId: "813329348858",
          appId: "1:813329348858:web:afa726940ad9b8c37cb143",
          measurementId: "G-1TF3R94EW9"
        };
        // ==========================================

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Kiểm tra trạng thái đăng nhập tự động
        auth.onAuthStateChanged((user) => {
            const loginUI = document.getElementById('login-ui');
            const appUI = document.getElementById('app-ui');
            
            if (user) {
                loginUI.style.display = 'none';
                appUI.style.display = 'block';
            } else {
                loginUI.style.display = 'block';
                appUI.style.display = 'none';
            }
        });

        // Hàm xử lý Đăng nhập
        function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { errorMsg.innerText = ""; })
                .catch((error) => { errorMsg.innerText = "Lỗi: " + error.message; });
        }

        // Hàm xử lý Đăng xuất
        function handleLogout() {
            auth.signOut();
        }

        // Xử lý đọc File sau khi người dùng chọn file
        document.getElementById('filePicker').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Hiển thị tên file ngay lập tức để biết web đã nhận file
    document.getElementById('file-details').innerText = `Đang đọc: ${file.name}...`;

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        // Đổ dữ liệu vào ô xem Log
        document.getElementById('log-viewer').value = content;
        document.getElementById('file-details').innerText = `File: ${file.name} | Dung lượng: ${(file.size/1024).toFixed(2)} KB`;
    };
    
    // Đảm bảo dùng bảng mã UTF-8 để không bị lỗi font tiếng Việt hoặc ký tự đặc biệt trong Log
    reader.readAsText(file, "UTF-8"); 
});        
    </script>

    <script>
    // 1. Các cấu hình Firebase của bạn dán ở đây...

    // 2. Hàm Parser (Bộ não lọc dữ liệu) - Dán đoạn này vào
    function parseATMLog(rawText) {
        const lines = rawText.split('\n');
        const transactions = [];
        let currentTrans = null;

        lines.forEach(line => {
            if (line.includes("TRANSACTION START")) {
                currentTrans = {
                    time: line.substring(0, 19),
                    type: line.includes("CARDLESS") ? "Không thẻ" : "Giao dịch thẻ",
                    trace: "", card: "", name: "", amount: "0", status: "Chờ..."
                };
            } 
            if (currentTrans) {
                if (line.includes("TRACE :")) currentTrans.trace = line.split(":")[1].trim();
                if (line.includes("CARD NUMBER")) currentTrans.card = line.split("NUMBER")[1].trim();
                if (line.includes("CUSTOMER NAME :")) currentTrans.name = line.split(":")[1].trim();
                if (line.includes("AMOUNT:")) currentTrans.amount = line.split(":")[1].trim();
                
                // Nhận diện kết quả
                if (line.includes("Success")) currentTrans.status = "Thành công";
                if (line.includes("ERROR") || line.includes("TIMEOUT")) currentTrans.status = "Lỗi/Timeout";
                if (line.includes("Money Taken")) currentTrans.status = "Thành công (Đã lấy tiền)";

                if (line.includes("TRANSACTION END")) {
                    transactions.push(currentTrans);
                    currentTrans = null;
                }
            }
        });
        return transactions;
    }

    // 3. Hàm hiển thị dữ liệu lên bảng
    function displayTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; // Xóa dữ liệu cũ
        data.forEach(item => {
            const row = `<tr>
                <td>${item.time}</td>
                <td>${item.trace}</td>
                <td>${item.card}</td>
                <td>${item.name}</td>
                <td>${item.amount}</td>
                <td style="color: ${item.status.includes('Lỗi') ? 'red' : 'green'}">${item.status}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // 4. Sự kiện khi chọn file (Kết nối bộ đọc với bảng)
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const parsedData = parseATMLog(content); // Chuyển văn bản thành danh sách
            displayTable(parsedData); // Đổ danh sách vào bảng
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>
