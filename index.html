<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATMLogTool - Tr√¨nh ƒë·ªçc Log chuy√™n nghi·ªáp</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; margin: 0; padding: 20px; }
        .app-container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #333; text-align: center; }
        .logout-btn { float: right; padding: 8px 15px; background: #ff4d4d; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* File Input Style */
        .file-input-group { border: 2px dashed #007bff; padding: 20px; text-align: center; border-radius: 10px; background: #f0f7ff; margin: 20px 0; }
        
        /* Search Bar */
        #searchInput { width: 100%; padding: 12px; border: 2px solid #007bff; border-radius: 5px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }

        /* Table Style */
        .table-wrapper { overflow-x: auto; max-height: 550px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { position: sticky; top: 0; background: #007bff; color: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f7ff; }
        
        .status-ok { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        #file-details { margin-bottom: 10px; font-style: italic; color: #666; }
    </style>
</head>
<body>

<div id="app-ui" class="app-container">
    <button class="logout-btn" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
    <h2>üè¶ Tr√¨nh ƒë·ªçc Log ATM chuy√™n nghi·ªáp</h2>
    <p style="text-align: center;">Tr·∫°ng th√°i: <span style="color: green; font-weight: bold;">‚óè ƒê√£ k·∫øt n·ªëi Firebase</span></p>

    <div class="file-input-group">
        <label for="filePicker" style="cursor: pointer; color: #007bff; font-weight: bold; font-size: 18px;">
            üìÅ M·ªùi ch·ªçn file Log (.log, .txt, .jrn)
        </label>
        <input type="file" id="filePicker" accept=".log,.txt,.jrn" style="display: block; margin: 15px auto;">
    </div>

    <div id="file-details">Vui l√≤ng ch·ªçn file ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch...</div>

    <div class="main-content">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç T√¨m nhanh: S·ªë th·∫ª, Trace, T√™n kh√°ch h√†ng...">
        
        <div class="table-wrapper">
            <table id="logTable">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>Trace</th>
                        <th>S·ªë th·∫ª</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #999;">
                            D·ªØ li·ªáu s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi b·∫°n ch·ªçn file.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. C·∫§U H√åNH FIREBASE (THAY TH·∫æ ƒêO·∫†N N√ÄY B·∫∞NG C·ª¶A B·∫†N) ---
   // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAI9JLeO3Wd4i-AOUGHRFVlNI4ZnVRv6I4",
      authDomain: "atmlogtoolauth.firebaseapp.com",
      projectId: "atmlogtoolauth",
      storageBucket: "atmlogtoolauth.firebasestorage.app",
      messagingSenderId: "813329348858",
      appId: "1:813329348858:web:afa726940ad9b8c37cb143",
      measurementId: "G-1TF3R94EW9"
    };
    firebase.initializeApp(firebaseConfig);

    // --- 2. X·ª¨ L√ù ƒê·ªåC FILE ---
    document.getElementById('filePicker').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('file-details').innerText = `ƒêang x·ª≠ l√Ω: ${file.name} (${(file.size/1024).toFixed(2)} KB)`;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const transactions = parseATMLog(content);
            renderTable(transactions);
        };
        reader.readAsText(file, "UTF-8");
    });

    // --- 3. B·ªò N√ÉO PH√ÇN T√çCH LOG (PARSER) ---
    function parseATMLog(rawText) {
        const lines = rawText.split('\n');
        const results = [];
        let item = null;

        lines.forEach(line => {
            // Nh·∫≠n di·ªán ƒëi·ªÉm b·∫Øt ƒë·∫ßu giao d·ªãch
            if (line.includes("TRANSACTION START") || line.includes("CARDLESS TRANSACTION START")) {
                item = {
                    time: line.substring(0, 19).trim(),
                    trace: "---",
                    card: "N/A",
                    name: "N/A",
                    amount: "0",
                    status: "Ch∆∞a ho√†n th√†nh"
                };
            }

            if (item) {
                // Tr√≠ch xu·∫•t d·ªØ li·ªáu d·ª±a tr√™n t·ª´ kh√≥a
                if (line.includes("TRACE :")) item.trace = line.split(":")[1].trim();
                if (line.includes("CARD NUMBER")) item.card = line.split("NUMBER")[1].trim();
                if (line.includes("CUSTOMER NAME :")) item.name = line.split(":")[1].trim();
                
                // Tr√≠ch xu·∫•t s·ªë ti·ªÅn t·ª´ nhi·ªÅu d·∫°ng d√≤ng kh√°c nhau
                if (line.includes("AMOUNT:")) item.amount = line.split(":")[1].trim();
                if (line.includes("ACCEPTED AMOUNT:")) item.amount = line.split(":")[1].trim();

                // X√°c ƒë·ªãnh tr·∫°ng th√°i
                if (line.includes("Success") || line.includes("Complete") || line.includes("Money Taken")) {
                    item.status = "Th√†nh c√¥ng";
                }
                if (line.includes("ERROR") || line.includes("TIMEOUT") || line.includes("HOST TIMEOUT")) {
                    item.status = "L·ªói / Timeout";
                }

                // K·∫øt th√∫c m·ªôt giao d·ªãch
                if (line.includes("TRANSACTION END")) {
                    results.push(item);
                    item = null;
                }
            }
        });
        return results;
    }

    // --- 4. HI·ªÇN TH·ªä D·ªÆ LI·ªÜU L√äN B·∫¢NG ---
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Kh√¥ng t√¨m th·∫•y c·∫•u tr√∫c giao d·ªãch trong file n√†y.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(tr => `
            <tr>
                <td>${tr.time}</td>
                <td><b>${tr.trace}</b></td>
                <td>${tr.card}</td>
                <td>${tr.name}</td>
                <td>${tr.amount}</td>
                <td class="${tr.status.includes('Th√†nh c√¥ng') ? 'status-ok' : 'status-error'}">${tr.status}</td>
            </tr>
        `).join('');
    }

    // --- 5. H√ÄM T√åM KI·∫æM ---
    function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const trs = document.getElementById("tableBody").getElementsByTagName("tr");

        for (let i = 0; i < trs.length; i++) {
            const text = trs[i].textContent || trs[i].innerText;
            trs[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    // --- 6. ƒêƒÇNG XU·∫§T ---
    function handleLogout() {
        firebase.auth().signOut().then(() => {
            alert("ƒê√£ ƒëƒÉng xu·∫•t!");
            window.location.reload();
        });
    }
</script>

</body>
</html>
